<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Encrypted Link Gateway - Browser</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --bg: #0f172a;
      --bg-card: #1e293b;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --border: #334155;
      /* Safe area insets for notched devices */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      /* Prevent iOS text size adjustment */
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: -webkit-fill-available; /* iOS Safari fix */
      display: flex;
      flex-direction: column;
      /* Prevent pull-to-refresh on iOS */
      overscroll-behavior-y: contain;
      /* Smooth scrolling on iOS */
      -webkit-overflow-scrolling: touch;
      /* Account for safe areas */
      padding-top: var(--safe-area-top);
      padding-bottom: var(--safe-area-bottom);
      padding-left: var(--safe-area-left);
      padding-right: var(--safe-area-right);
    }
    
    /* Fix for iOS 100vh issue */
    html {
      height: -webkit-fill-available;
    }
    
    .toolbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      /* Prevent sticky hover on touch */
      -webkit-tap-highlight-color: transparent;
    }
    
    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .toolbar label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .toolbar input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 1rem; /* Prevent iOS zoom on focus */
      min-width: 200px;
      /* Prevent iOS input styling */
      -webkit-appearance: none;
      appearance: none;
    }
    
    .toolbar input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .toolbar input.url-input {
      flex: 1;
      min-width: 300px;
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem; /* Larger touch target for iPad */
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      /* Touch-friendly */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      /* Minimum 44px touch target for iOS */
      min-height: 44px;
      min-width: 44px;
    }
    
    button:hover {
      background: var(--primary-dark);
    }
    
    /* Remove sticky hover on touch devices */
    @media (hover: none) {
      button:hover {
        background: var(--primary);
      }
      .btn-secondary:hover {
        background: transparent;
      }
    }
    
    button:active {
      background: var(--primary-dark);
      transform: scale(0.98);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--border);
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-indicator.connected {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }
    
    .status-indicator.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: var(--error);
    }
    
    .status-indicator.loading {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }
    
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .browser-frame {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      position: relative;
    }
    
    .browser-frame iframe {
      flex: 1;
      border: none;
      width: 100%;
      height: 100%;
      /* Safari iframe fixes */
      -webkit-overflow-scrolling: touch;
      overflow: auto;
    }
    
    /* Fullscreen video support for iPad */
    .browser-frame iframe:fullscreen,
    .browser-frame iframe:-webkit-full-screen {
      width: 100vw;
      height: 100vh;
    }
    
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      background: var(--bg);
    }
    
    .welcome-screen h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--primary), #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .welcome-screen p {
      color: var(--text-muted);
      max-width: 500px;
      margin-bottom: 2rem;
    }
    
    .welcome-screen .steps {
      text-align: left;
      background: var(--bg-card);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .welcome-screen .steps h3 {
      margin-bottom: 1rem;
    }
    
    .welcome-screen .steps ol {
      padding-left: 1.5rem;
    }
    
    .welcome-screen .steps li {
      margin-bottom: 0.5rem;
      color: var(--text-muted);
    }
    
    .welcome-screen .steps code {
      background: var(--bg);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .log-panel {
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      max-height: 150px;
      overflow-y: auto;
      padding: 0.5rem 1rem;
      font-family: monospace;
      font-size: 0.75rem;
      display: none;
    }
    
    .log-panel.visible {
      display: block;
    }
    
    .log-entry {
      padding: 0.125rem 0;
      color: var(--text-muted);
    }
    
    .log-entry.success { color: var(--success); }
    .log-entry.error { color: var(--error); }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    
    .loading-overlay.hidden {
      display: none;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-display {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem;
      color: var(--error);
    }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-section">
      <span id="status" class="status-indicator disconnected">
        <span class="dot"></span>
        <span id="status-text">Disconnected</span>
      </span>
    </div>
    
    <div class="toolbar-section">
      <label>Gateway:</label>
      <input type="text" id="gateway-url" value="http://localhost:3000" placeholder="http://localhost:3000">
      <button id="connect-btn" onclick="connect()">Connect</button>
    </div>
    
    <div class="toolbar-section" style="flex: 1;">
      <label>Browse:</label>
      <input type="text" id="target-url" class="url-input" value="https://mojhheh.github.io" placeholder="https://mojhheh.github.io" disabled>
      <button id="go-btn" onclick="browse()" disabled>Go</button>
    </div>
    
    <div class="toolbar-section">
      <button class="btn-secondary" onclick="toggleLog()">üìã Log</button>
    </div>
  </div>
  
  <!-- Browser Frame -->
  <div class="browser-frame" id="browser-frame">
    <div class="welcome-screen" id="welcome-screen">
      <h1>üîê Encrypted Link Gateway</h1>
      <p>Browse websites securely through tokenized URLs. All requests are proxied and encrypted.</p>
      
      <div class="steps">
        <h3>Quick Start</h3>
        <ol>
          <li>Gateway URL is set to <code>http://localhost:3000</code></li>
          <li>Click <strong>Connect</strong> to establish a session</li>
          <li>Enter a URL (default: <code>https://mojhheh.github.io</code>)</li>
          <li>Click <strong>Go</strong> to view the site through the gateway</li>
        </ol>
      </div>
    </div>
    
    <iframe id="content-frame" style="display: none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation"></iframe>
    
    <div class="loading-overlay hidden" id="loading">
      <div class="spinner"></div>
    </div>
  </div>
  
  <!-- Log Panel -->
  <div class="log-panel" id="log-panel">
    <div class="log-entry">[--:--:--] Gateway browser ready</div>
  </div>
  
  <script>
    // State
    let gatewayBase = '';
    let sessionToken = null;
    let connected = false;
    
    // DOM Elements
    const statusEl = document.getElementById('status');
    const statusTextEl = document.getElementById('status-text');
    const gatewayUrlInput = document.getElementById('gateway-url');
    const targetUrlInput = document.getElementById('target-url');
    const connectBtn = document.getElementById('connect-btn');
    const goBtn = document.getElementById('go-btn');
    const welcomeScreen = document.getElementById('welcome-screen');
    const contentFrame = document.getElementById('content-frame');
    const logPanel = document.getElementById('log-panel');
    const loadingEl = document.getElementById('loading');
    
    // Logging
    function log(message, type = 'info') {
      const now = new Date();
      const time = now.toTimeString().slice(0, 8);
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${time}] ${message}`;
      
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function toggleLog() {
      logPanel.classList.toggle('visible');
    }
    
    function showLoading(show) {
      loadingEl.classList.toggle('hidden', !show);
    }
    
    function updateStatus(state) {
      statusEl.className = `status-indicator ${state}`;
      
      switch (state) {
        case 'connected':
          statusTextEl.textContent = 'Connected';
          connectBtn.textContent = 'Reconnect';
          targetUrlInput.disabled = false;
          goBtn.disabled = false;
          break;
        case 'disconnected':
          statusTextEl.textContent = 'Disconnected';
          connectBtn.textContent = 'Connect';
          targetUrlInput.disabled = true;
          goBtn.disabled = true;
          break;
        case 'loading':
          statusTextEl.textContent = 'Connecting...';
          break;
      }
    }
    
    // Connect to gateway
    async function connect() {
      gatewayBase = gatewayUrlInput.value.replace(/\/$/, '');
      
      if (!gatewayBase) {
        log('Please enter a gateway URL', 'error');
        return;
      }
      
      updateStatus('loading');
      log(`Connecting to ${gatewayBase}...`);
      
      try {
        const response = await fetch(`${gatewayBase}/session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`Session creation failed: ${response.status}`);
        }
        
        const data = await response.json();
        sessionToken = data.sessionToken;
        connected = true;
        
        updateStatus('connected');
        log(`Connected! Session expires: ${data.expiresAt}`, 'success');
        
      } catch (e) {
        log(`Connection failed: ${e.message}`, 'error');
        updateStatus('disconnected');
      }
    }
    
    // Tokenize URL
    async function tokenizeUrl(url) {
      const response = await fetch(`${gatewayBase}/tokenize`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionToken}`
        },
        body: JSON.stringify({ url })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.reason || error.error || 'Tokenization failed');
      }
      
      const data = await response.json();
      return data.token;
    }
    
    // Browse URL through gateway
    async function browse() {
      if (!connected || !sessionToken) {
        log('Not connected - connect first!', 'error');
        return;
      }
      
      let url = targetUrlInput.value.trim();
      if (!url) {
        log('Please enter a URL to browse', 'error');
        return;
      }
      
      // Add https:// if no protocol
      if (!url.match(/^https?:\/\//)) {
        url = 'https://' + url;
        targetUrlInput.value = url;
      }
      
      log(`Browsing: ${url}`);
      showLoading(true);
      
      try {
        const token = await tokenizeUrl(url);
        log(`Token obtained: ${token.slice(0, 16)}...`, 'success');
        
        // Build gateway URL
        // Use SSR gateway endpoint for more reliable rendering
        const gatewayUrl = `${gatewayBase}/go-ssr/${token}`;
        
        // Hide welcome, show iframe
        welcomeScreen.style.display = 'none';
        contentFrame.style.display = 'block';
        
        // Load content via iframe src (not srcdoc) for proper origin and click handling
        // Set controlled sandbox - avoid allow-top-navigation and allow-same-origin for security
        contentFrame.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-presentation allow-modals');
        contentFrame.src = gatewayUrl;
        
        log(`Loaded ${url} through gateway`, 'success');
        
      } catch (e) {
        log(`Browse failed: ${e.message}`, 'error');
        
        // Show error in frame - HTML-escape the error message to prevent XSS
        const escapeHtml = (str) => {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        };
        const safeMessage = escapeHtml(e.message || 'Unknown error');
        
        welcomeScreen.style.display = 'none';
        contentFrame.style.display = 'block';
        contentFrame.srcdoc = `
          <html>
          <head><style>
            body { font-family: sans-serif; padding: 2rem; background: #0f172a; color: #e2e8f0; }
            .error { background: rgba(239,68,68,0.1); border: 1px solid #ef4444; padding: 1rem; border-radius: 8px; color: #ef4444; }
          </style></head>
          <body>
            <div class="error">
              <h2>Error Loading Page</h2>
              <p>${safeMessage}</p>
              <p>Make sure the URL is in the gateway's allowed origins list.</p>
            </div>
          </body>
          </html>
        `;
      } finally {
        showLoading(false);
      }
    }
    
    // Handle Enter key
    targetUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') browse();
    });
    
    gatewayUrlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') connect();
    });
    
    // Init
    window.addEventListener('load', () => {
      log('Gateway browser ready');
      log('Click Connect to start');
    });
  </script>
</body>
</html>
